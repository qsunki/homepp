<!-- cam.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Video Provider</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
<video id="localVideo" autoplay playsinline></video>
<script>
    const localVideo = document.getElementById('localVideo');
    let localStream;
    let peerConnections = {};
    let key = 0;
    let subscription;

    const socketIO = io.connect('http://127.0.0.1:8000');

    socketIO.on('stream_id_update', function(data) {
        key = data.stream_id;
        console.log("Updated Stream ID:", key);
        startVideoStream();
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
        }
        subscription = stompClient.subscribe(`/sub/cam/${key}`, (message) => {
            console.log('message is ', message)
            const signal = JSON.parse(message.body);
            handleSignal(signal);
        });
    });

    socketIO.on('stop_stream', function() {
        if (subscription) {
            subscription.unsubscribe();
            subscription = null;
        }
        stopVideoStream();
    });

    const socket = new SockJS('http://i11a605.p.ssafy.io:8081/ws');
        const stompClient = new StompJs.Client({
            webSocketFactory: () => socket
        });

    function startVideoStream() {
        console.log('call startVideoStream')
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            localVideo.srcObject = stream;
            localStream = stream;
        }).catch(error => {
            console.error('Error accessing media devices.', error);
        });
    }

    stompClient.onConnect = (frame) => {
        console.log('onConnect')
        console.log(key)
        subscription = stompClient.subscribe(`/sub/cam/${key}`, (message) => {
            console.log('message is ', message)
            const signal = JSON.parse(message.body);
            handleSignal(signal);
        });
    };

    stompClient.activate();

    function handleSignal(signal) {
        console.log('signal is ', signal)
        const signalData = signal.data;

        switch (signal.type) {
            case 'offer':
                createAnswer(signalData);
                break;
            case 'candidate':
                addCandidate(signalData);
                console.log('addCandidated')
                break;
        }
    }

    function createAnswer(offer) {
        console.log('offer is ', offer)
        const peerConnection = new RTCPeerConnection({
            iceServers: [
                {
                    "urls": "stun:i11a605.p.ssafy.io",
                    "username": "username",
                    "credential": "password"
                },
                {
                    "urls": "turn:i11a605.p.ssafy.io",
                    "username": "username",
                    "credential": "password"
                }
            ]
        });
        peerConnection.onicecandidate = event => {
            console.log('icecandidate event occurred ', event)
            if (event.candidate) {
                stompClient.publish({
                    destination: `/pub/cam/${key}`,
                    body: JSON.stringify({ type: 'candidate', data: event.candidate })
                });
            }
        };
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        peerConnection.createAnswer({offerToReceiveVideo: true}).then(answer => {
            peerConnection.setLocalDescription(answer);
            stompClient.publish({
                destination: `/pub/cam/${key}`,
                body: JSON.stringify({ type: 'answer', data: answer })
            });
        });
        peerConnections[offer.sender] = peerConnection;
    }

    function addCandidate(candidate) {
        peerConnections[candidate.sender].addIceCandidate(new RTCIceCandidate(candidate));
    }

    function stopVideoStream() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop()); // Stop all tracks
            localVideo.srcObject = null; // Remove video source
            console.log("Video stream stopped");
        }
    }
</script>
</body>
</html>