<!DOCTYPE html>
<html lang="ko">
<head>
    <title>Video Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
<button id="startButton">Start</button>
<video id="remoteVideo" autoplay playsinline></video>
<script>
    const remoteVideo = document.getElementById('remoteVideo');
    const startButton = document.getElementById('startButton');
    let peerConnection;

    const socket = new SockJS('http://i11a605.p.ssafy.io:8081/ws');
    const stompClient = new StompJs.Client({
        webSocketFactory: () => socket
    });

    stompClient.onConnect = (frame) => {
        stompClient.subscribe('/sub/client/124', (message) => {
            const signal = JSON.parse(message.body);
            handleSignal(signal);
        });
    };

    stompClient.activate();

    function handleSignal(signal) {
        console.log('signal is ', signal)
        switch (signal.type) {
            case 'answer':
                console.log('answer signal is ', signal.data)
                handleAnswer(signal.data);
                break;
            case 'candidate':
                console.log('candidate signal is ', signal.data)
                addCandidate(signal.data);
                break;
        }
    }

    startButton.addEventListener('click', () => {
        sendOffer();
    });

    function sendOffer() {
        console.log('send offer!');
        const configuration = {
            iceServers: [
                {
                    urls: 'turn:i11a605.p.ssafy.io:3478', // TURN 서버 주소
                    username: 'username', // TURN 서버 사용자 이름
                    credential: 'password' // TURN 서버 비밀번호
                }
            ],
            // iceTransportPolicy: 'relay' // 릴레이 후보만 사용하도록 설정
        };

        peerConnection = new RTCPeerConnection(configuration);

        peerConnection.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }).then(async offer => {
            await peerConnection.setLocalDescription(offer);
            stompClient.publish({
                destination: '/pub/client/124',
                body: JSON.stringify({ type: 'offer', data: offer })
            });
        });

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                console.log('publish candidate message');
                stompClient.publish({
                    destination: '/pub/client/124',
                    body: JSON.stringify({ type: 'candidate', data: event.candidate })
                });
            } else {
                console.log('All ICE candidates have been sent');
            }
        };

        peerConnection.ontrack = event => {
            console.log('ontrack event occurred');
            const [remoteStream] = event.streams;
            remoteVideo.srcObject = remoteStream;
            remoteVideo.play();
        };

        peerConnection.addEventListener('iceconnectionstatechange', () => {
            console.log('ICE connection state:', peerConnection.iceConnectionState);
        });
    }

    function handleAnswer(answer) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    }

    function addCandidate(candidate) {
        console.log('candidate is ', candidate);
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }

    window.addEventListener('beforeunload', (event) => {
        console.log('beforeunload');
        stompClient.publish({
            destination: '/pub/client/124',
            body: JSON.stringify({ type: 'disconnection' })
        });
        // Perform the cleanup or other necessary actions here
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        event.preventDefault();
        event.returnValue = '';
    });
</script>
</body>
</html>
